const t=_,e='涓夋湀鍓ф湰寮曟搸',n='-涓夋湀鍓ф湰',i='涓夋湀鐨勪笘鐣屽墽鏈?;let r=null;function o(){const t=getScriptId(),e=getVariables({type:'script',script_id:t}),n=_.get(e,'ui_position');return'sidebar'===n||'extensions'===n?'sidebar':'quick_reply'}function s(){const t=getChatWorldbookName('current');return'string'==typeof t?t:''}function a(t){return!!t&&t.endsWith(n)}function c(){const t=s(),n=a(t);insertOrAssignVariables({[e]:{涓栫晫涔﹀凡缁戝畾:n,褰撳墠缁戝畾涓栫晫涔?t,棰勮:_.get(getVariables({type:'chat'}),[e,'棰勮'],'')}},{type:'chat'})}function p(t){const n=getVariables({type:'chat'}),i=_.get(n,e)||{};insertOrAssignVariables({[e]:{...i,棰勮:t}},{type:'chat'})}function d(){$('#march-script-simple-panel').remove()}function l(){$('#march-script-ext-button').remove(),$('#march-script-sidebar-button').remove(),$('#march-script-inline-drawer').remove(),$('#march-script-menu-item').remove(),$('#march-script-float-btn').remove()}function u(){l();const t=$('#extensionsMenu');if(t.length>0){const e=$(`<div class="extension_container interactable" id="march-script-menu-item" tabindex="0" script_id="${getScriptId()}"></div>`),n=$(`<div class="list-group-item flex-container flexGap5 interactable" title="${i}">\n        <div class="fa-fw fa-solid fa-scroll extensionsMenuExtensionButton"></div>\n        <span>${i}</span>\n      </div>`);return n.on('click',async e=>{e.stopPropagation();const n=$('#extensionsMenuButton');n.length>0&&t.is(':visible')&&(n.trigger('click'),await new Promise(t=>setTimeout(t,120))),f()}),e.append(n),t.append(e),!0}const e=$(`<div id="march-script-float-btn" title="${i}" style="position:fixed;bottom:80px;right:16px;z-index:99999;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#ec4899);color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(124,58,237,.4);">馃摐</div>`);return e.on('click',()=>f()),$('body').append(e),!0}function b(){null===r&&(r=window.setInterval(()=>{'sidebar'===o()&&($('#march-script-sidebar-button').length>0||u()||replaceScriptButtons([{name:i,visible:!0}]))},1200))}function g(){null!==r&&(clearInterval(r),r=null)}function x(t){if('sidebar'===t)return replaceScriptButtons([]),u()||(replaceScriptButtons([{name:i,visible:!0}]),toastr.warning('鏈壘鍒版墿灞曡彍鍗曞鍣紝宸蹭复鏃跺洖閫€鍒板揩閫熷洖澶嶅尯鎸夐挳銆?)),void b();g(),l(),replaceScriptButtons([{name:i,visible:!0}])}function f(){d(),c();const i=getVariables({type:'chat'}),r=_.get(i,e)||{},s=!!r.涓栫晫涔﹀凡缁戝畾,a=(r.褰撳墠缁戝畾涓栫晫涔|'').toString(),l=(r.棰勮||'').toString(),u=o(),b=$(`\n    <div id="march-script-simple-panel" style="\n      position: fixed;\n      right: 16px;\n      top: 72px;\n      width: min(520px, 92vw);\n      max-height: 78vh;\n      overflow: auto;\n      z-index: 10010;\n      background: rgba(255, 255, 255, 0.8);\n      color: #222;\n      border: 1px solid rgba(0,0,0,0.2);\n      border-radius: 10px;\n      box-shadow: 0 8px 22px rgba(0,0,0,0.25);\n      padding: 12px;\n      backdrop-filter: blur(4px);\n    ">\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">\n        <strong>涓夋湀鍓ф湰寮曟搸锛堢畝绾﹂潰鏉匡級</strong>\n        <button id="march-close" style="border:1px solid #999; background:#fff; border-radius:6px; padding:2px 8px; cursor:pointer;">鍏抽棴</button>\n      </div>\n      <div style="font-size:13px; line-height:1.6; margin-bottom:8px;">\n        <div>涓栫晫涔﹀凡缁戝畾锛?strong>${s?'鏄?:'鍚?}</strong></div>\n        <div>褰撳墠缁戝畾涓栫晫涔︼細<code>${a||'(绌?'}</code></div>\n        <div>瑕佹眰鍚庣紑锛?code>${n}</code></div>\n      </div>\n      <div style="margin-bottom:8px; font-size:13px;">\n        <strong>鍏ュ彛浣嶇疆锛堜簩閫変竴锛?/strong>\n        <div style="display:flex; gap:8px; margin-top:6px;">\n          <select id="march-ui-position" style="flex:1; border:1px solid #aaa; border-radius:8px; padding:6px;">\n            <option value="quick_reply" ${'quick_reply'===u?'selected':''}>蹇€熷洖澶嶅尯</option>\n            <option value="sidebar" ${'sidebar'===u?'selected':''}>鎵╁睍鑿滃崟鏍?/option>\n          </select>\n          <button id="march-apply-position" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">搴旂敤浣嶇疆</button>\n        </div>\n      </div>\n      <div style="margin-bottom:6px; font-size:13px;"><strong>鍓ф湰棰勮锛堝彂缁橝I鍓嶆敞鍏ワ級</strong></div>\n      <textarea id="march-preset" style="width:100%; min-height:180px; box-sizing:border-box; border:1px solid #aaa; border-radius:8px; padding:8px;">${_.escape(l)}</textarea>\n      <div style="display:flex; gap:8px; margin-top:8px;">\n        <button id="march-save" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">淇濆瓨棰勮</button>\n        <button id="march-refresh" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">鍒锋柊缁戝畾鐘舵€?/button>\n        <button id="march-clear" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">娓呯┖棰勮</button>\n      </div>\n    </div>\n  `);$('body').append(b),b.find('#march-close').on('click',()=>d()),b.find('#march-save').on('click',()=>{p((b.find('#march-preset').val()||'').toString()),toastr.success('棰勮宸蹭繚瀛?)}),b.find('#march-refresh').on('click',()=>{c(),toastr.success('缁戝畾鐘舵€佸凡鍒锋柊'),f()}),b.find('#march-clear').on('click',()=>{b.find('#march-preset').val(''),p(''),toastr.success('棰勮宸叉竻绌?)}),b.find('#march-apply-position').on('click',()=>{const e='sidebar'===String(b.find('#march-ui-position').val()||'quick_reply')?'sidebar':'quick_reply';!function(e){const n=getScriptId(),i=getVariables({type:'script',script_id:n})||{},r=(0,t.cloneDeep)(i);_.set(r,'ui_position',e),replaceVariables(r,{type:'script',script_id:n})}(e),x(e),toastr.success('鍏ュ彛宸插垏鎹㈠埌锛?+('sidebar'===e?'鎵╁睍鑿滃崟鏍?:'蹇€熷洖澶嶅尯'))})}async function m(){c(),eventOn(getButtonEvent(i),()=>{f()}),x(o()),eventOn(tavern_events.CHAT_CHANGED,()=>{c(),x(o())}),eventOn(tavern_events.GENERATION_STARTED,()=>{if(c(),!a(s()))return void toastr.warning(`璇峰厛缁戝畾鍚庣紑涓衡€?{n}鈥濈殑涓栫晫涔︺€俙);const t=function(){const t=getVariables({type:'chat'});return(_.get(t,[e,'棰勮'])||'').toString().trim()}();t&&injectPrompts([{id:'march-world-script-preset',position:'in_chat',depth:0,role:'system',should_scan:!0,content:t}])}),b(),$(window).on('pagehide',()=>{g(),l(),d()}),console.info('涓夋湀鍓ф湰寮曟搸锛堥€氱敤锛夊凡鍔犺浇')}$(()=>{errorCatched(m)()});
//# sourceMappingURL=index.js.map

