const t=_,e='ä¸‰æœˆå‰§æœ¬å¼•æ“',n='-ä¸‰æœˆå‰§æœ¬',i='ä¸‰æœˆçš„ä¸–ç•Œå‰§æœ¬';let r=null;function o(){const t=getScriptId(),e=getVariables({type:'script',script_id:t}),n=_.get(e,'ui_position');return'sidebar'===n||'extensions'===n?'sidebar':'quick_reply'}function s(){const t=getChatWorldbookName('current');return'string'==typeof t?t:''}function a(t){return!!t&&t.endsWith(n)}function c(){const t=s(),n=a(t);insertOrAssignVariables({[e]:{ä¸–ç•Œä¹¦å·²ç»‘å®š:n,å½“å‰ç»‘å®šä¸–ç•Œä¹¦:t,é¢„è®¾:_.get(getVariables({type:'chat'}),[e,'é¢„è®¾'],'')}},{type:'chat'})}function p(t){const n=getVariables({type:'chat'}),i=_.get(n,e)||{};insertOrAssignVariables({[e]:{...i,é¢„è®¾:t}},{type:'chat'})}function d(){$('#march-script-simple-panel').remove()}function l(){$('#march-script-ext-button').remove(),$('#march-script-sidebar-button').remove(),$('#march-script-inline-drawer').remove(),$('#march-script-menu-item').remove(),$('#march-script-float-btn').remove()}function u(){l();const t=$('#extensionsMenu');if(t.length>0){const e=$(`<div class="extension_container interactable" id="march-script-menu-item" tabindex="0" script_id="${getScriptId()}"></div>`),n=$(`<div class="list-group-item flex-container flexGap5 interactable" title="${i}">\n        <div class="fa-fw fa-solid fa-scroll extensionsMenuExtensionButton"></div>\n        <span>${i}</span>\n      </div>`);return n.on('click',async e=>{e.stopPropagation();const n=$('#extensionsMenuButton');n.length>0&&t.is(':visible')&&(n.trigger('click'),await new Promise(t=>setTimeout(t,120))),f()}),e.append(n),t.append(e),!0}const e=$(`<div id="march-script-float-btn" title="${i}" style="position:fixed;bottom:80px;right:16px;z-index:99999;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#ec4899);color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(124,58,237,.4);">ğŸ“œ</div>`);return e.on('click',()=>f()),$('body').append(e),!0}function b(){null===r&&(r=window.setInterval(()=>{'sidebar'===o()&&($('#march-script-sidebar-button').length>0||u()||replaceScriptButtons([{name:i,visible:!0}]))},1200))}function g(){null!==r&&(clearInterval(r),r=null)}function x(t){if('sidebar'===t)return replaceScriptButtons([]),u()||(replaceScriptButtons([{name:i,visible:!0}]),toastr.warning('æœªæ‰¾åˆ°æ‰©å±•èœå•å®¹å™¨ï¼Œå·²ä¸´æ—¶å›é€€åˆ°å¿«é€Ÿå›å¤åŒºæŒ‰é’®ã€‚')),void b();g(),l(),replaceScriptButtons([{name:i,visible:!0}])}function f(){d(),c();const i=getVariables({type:'chat'}),r=_.get(i,e)||{},s=!!r.ä¸–ç•Œä¹¦å·²ç»‘å®š,a=(r.å½“å‰ç»‘å®šä¸–ç•Œä¹¦||'').toString(),l=(r.é¢„è®¾||'').toString(),u=o(),b=$(`\n    <div id="march-script-simple-panel" style="\n      position: fixed;\n      right: 16px;\n      top: 72px;\n      width: min(520px, 92vw);\n      max-height: 78vh;\n      overflow: auto;\n      z-index: 10010;\n      background: rgba(255, 255, 255, 0.8);\n      color: #222;\n      border: 1px solid rgba(0,0,0,0.2);\n      border-radius: 10px;\n      box-shadow: 0 8px 22px rgba(0,0,0,0.25);\n      padding: 12px;\n      backdrop-filter: blur(4px);\n    ">\n      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">\n        <strong>ä¸‰æœˆå‰§æœ¬å¼•æ“ï¼ˆç®€çº¦é¢æ¿ï¼‰</strong>\n        <button id="march-close" style="border:1px solid #999; background:#fff; border-radius:6px; padding:2px 8px; cursor:pointer;">å…³é—­</button>\n      </div>\n      <div style="font-size:13px; line-height:1.6; margin-bottom:8px;">\n        <div>ä¸–ç•Œä¹¦å·²ç»‘å®šï¼š<strong>${s?'æ˜¯':'å¦'}</strong></div>\n        <div>å½“å‰ç»‘å®šä¸–ç•Œä¹¦ï¼š<code>${a||'(ç©º)'}</code></div>\n        <div>è¦æ±‚åç¼€ï¼š<code>${n}</code></div>\n      </div>\n      <div style="margin-bottom:8px; font-size:13px;">\n        <strong>å…¥å£ä½ç½®ï¼ˆäºŒé€‰ä¸€ï¼‰</strong>\n        <div style="display:flex; gap:8px; margin-top:6px;">\n          <select id="march-ui-position" style="flex:1; border:1px solid #aaa; border-radius:8px; padding:6px;">\n            <option value="quick_reply" ${'quick_reply'===u?'selected':''}>å¿«é€Ÿå›å¤åŒº</option>\n            <option value="sidebar" ${'sidebar'===u?'selected':''}>æ‰©å±•èœå•æ </option>\n          </select>\n          <button id="march-apply-position" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">åº”ç”¨ä½ç½®</button>\n        </div>\n      </div>\n      <div style="margin-bottom:6px; font-size:13px;"><strong>å‰§æœ¬é¢„è®¾ï¼ˆå‘ç»™AIå‰æ³¨å…¥ï¼‰</strong></div>\n      <textarea id="march-preset" style="width:100%; min-height:180px; box-sizing:border-box; border:1px solid #aaa; border-radius:8px; padding:8px;">${_.escape(l)}</textarea>\n      <div style="display:flex; gap:8px; margin-top:8px;">\n        <button id="march-save" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">ä¿å­˜é¢„è®¾</button>\n        <button id="march-refresh" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">åˆ·æ–°ç»‘å®šçŠ¶æ€</button>\n        <button id="march-clear" style="border:1px solid #666; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer;">æ¸…ç©ºé¢„è®¾</button>\n      </div>\n    </div>\n  `);$('body').append(b),b.find('#march-close').on('click',()=>d()),b.find('#march-save').on('click',()=>{p((b.find('#march-preset').val()||'').toString()),toastr.success('é¢„è®¾å·²ä¿å­˜')}),b.find('#march-refresh').on('click',()=>{c(),toastr.success('ç»‘å®šçŠ¶æ€å·²åˆ·æ–°'),f()}),b.find('#march-clear').on('click',()=>{b.find('#march-preset').val(''),p(''),toastr.success('é¢„è®¾å·²æ¸…ç©º')}),b.find('#march-apply-position').on('click',()=>{const e='sidebar'===String(b.find('#march-ui-position').val()||'quick_reply')?'sidebar':'quick_reply';!function(e){const n=getScriptId(),i=getVariables({type:'script',script_id:n})||{},r=(0,t.cloneDeep)(i);_.set(r,'ui_position',e),replaceVariables(r,{type:'script',script_id:n})}(e),x(e),toastr.success('å…¥å£å·²åˆ‡æ¢åˆ°ï¼š'+('sidebar'===e?'æ‰©å±•èœå•æ ':'å¿«é€Ÿå›å¤åŒº'))})}async function m(){c(),eventOn(getButtonEvent(i),()=>{f()}),x(o()),eventOn(tavern_events.CHAT_CHANGED,()=>{c(),x(o())}),eventOn(tavern_events.GENERATION_STARTED,()=>{if(c(),!a(s()))return void toastr.warning(`è¯·å…ˆç»‘å®šåç¼€ä¸ºâ€œ${n}â€çš„ä¸–ç•Œä¹¦ã€‚`);const t=function(){const t=getVariables({type:'chat'});return(_.get(t,[e,'é¢„è®¾'])||'').toString().trim()}();t&&injectPrompts([{id:'march-script-engine-preset',position:'in_chat',depth:0,role:'system',should_scan:!0,content:t}])}),b(),$(window).on('pagehide',()=>{g(),l(),d()}),console.info('ä¸‰æœˆå‰§æœ¬å¼•æ“ï¼ˆé€šç”¨ï¼‰å·²åŠ è½½')}$(()=>{errorCatched(m)()});
//# sourceMappingURL=index.js.map