const n='⚝︎三月的世界剧本',e='三月的世界剧本',t='-三月剧本';function i(){return window.getScriptId()}function o(){return window.getVariables({type:'script',script_id:i()})||{}}function d(){return window.getVariables({type:'chat'})||{}}function s(){return'sidebar'===o().ui_position?'sidebar':'quickreply'}function a(){return function(){const n=window.getChatWorldbookName('current');return'string'==typeof n?n:''}().endsWith(t)}function c(){window.$('#march-world-panel').remove()}function r(){c();const r=d()[e]||{},l=s(),w=`\n  <div id="march-world-panel" style="position:fixed;right:16px;top:72px;width:min(92vw,620px);max-height:82vh;z-index:10010;background:#faf9f6;border:1px solid #c5d5e4;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:12px;overflow:auto;">\n    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">\n      <strong>${n}</strong>\n      <div style="display:flex;gap:6px;">\n        <button id="mw-setting">设置</button><button id="mw-close">关闭</button>\n      </div>\n    </div>\n    <div id="mw-setting-box" style="display:none;border-top:1px solid #d9e3ec;padding-top:8px;margin-top:8px;">\n      <div>当前版本：<code>ces-v1.0.1</code></div>\n      <div>最新版本：<code>ces-v1.0.1</code> <button id="mw-update">更新</button></div>\n      <div style="margin-top:8px;">入口位置：\n        <select id="mw-pos">\n          <option value="quickreply" ${'quickreply'===l?'selected':''}>快速回复</option>\n          <option value="sidebar" ${'sidebar'===l?'selected':''}>扩展菜单</option>\n        </select>\n      </div>\n      <div style="margin-top:8px;">API：\n        <select id="mw-api-mode">\n          <option value="default" ${'default'===(r.api_mode||'default')?'selected':''}>默认API</option>\n          <option value="independent" ${'independent'===(r.api_mode||'default')?'selected':''}>独立API</option>\n        </select>\n      </div>\n      <button id="mw-save" style="margin-top:8px;">保存设置</button>\n    </div>\n    <div style="margin-top:10px;color:#4a6785;">世界书绑定：<b>${a()?'已绑定':'未绑定'}</b>（要求后缀 ${t}）</div>\n  </div>`;window.$('body').append(w);const $=window.$;$('#mw-close').on('click',c),$('#mw-setting').on('click',()=>$('#mw-setting-box').toggle()),$('#mw-save').on('click',()=>{const n=String($('#mw-pos').val()||'quickreply'),t=String($('#mw-api-mode').val()||'default');!function(n){const e=o();e.ui_position=n,window.replaceVariables(e,{type:'script',script_id:i()})}(n),function(n){const t=d()[e]||{};window.insertOrAssignVariables({[e]:{...t,...n}},{type:'chat'})}({api_mode:t}),p(),window.toastr?.success?.('设置已保存')}),$('#mw-update').on('click',()=>location.reload())}function p(){window.$('#march-world-menu-item').remove(),window.replaceScriptButtons([]);const $=window.$;if('sidebar'===s()){const e=$('#extensionsMenu');if(e.length){const t=$(`<div id="march-world-menu-item" class="extension_container interactable" tabindex="0"><div class="list-group-item flex-container flexGap5 interactable"><div class="fa-fw fa-solid fa-scroll"></div><span>${n}</span></div></div>`);return t.on('click',r),void e.append(t)}}window.replaceScriptButtons([{name:n,visible:!0}])}async function l(){window.eventOn(window.getButtonEvent(n),r),window.eventOn(window.tavern_events.CHAT_CHANGED,p),window.eventOn(window.tavern_events.GENERATION_STARTED,()=>{a()||window.toastr?.warning?.(`请绑定后缀为“${t}”的世界书`)}),p(),window.console.info('三月的世界剧本（通用）已加载'),window.toastr?.success?.('三月的世界剧本已加载')}window.$(()=>window.errorCatched(l)());
//# sourceMappingURL=index.js.map